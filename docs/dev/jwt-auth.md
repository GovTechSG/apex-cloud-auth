# JWT Authentication

APEX Supports JWT Authentication as a secure means to secure the API transaction between a Consumer (API Requester) and Publisher (owner of API endpoint).

## Prerequisites-API Endpoint URL

The Developer will have to get the API Endpoint URL from the Publisher.  This will be the API which the API request is to be made to. (eg. <https://public.api.gov.sg/agency/api>)

## Prerequisites-API Key(s)

The Developer will have to create the respective Application to subscribe to the API(s) provided by the Publisher. (eg. xxxxx-xx-xxxxx)

Please note that 2 API Keys will be required for bridging APIs. (eg. key1: xxxxx-xx-xxxxx, key2: yyyyy-yy-yyyyy)

<!-- TODO: Add image of API Key(s)-->

## Prerequisites-JWKS Endpoint

The Developer will have to generate a JWK key for signing their authorization header, which consists of a private and public JWK key set, either with RS256 or ES256 signing algorithm.

With the **public key**, the developer will have to either,

- Publish a JWKS endpoint ([RFC7517](https://www.rfc-editor.org/rfc/rfc7517#appendix-A.1)), or
- Provide a string text of JWKS in the same format when creating the application.

Do note that your key-ID (kid) is used to identify your signing key in case more than 1 key is appended for purposes of key rotation.

Usually the key/value pairs of "***use***", "***kid***" will have to be appended to your key generated by a library.

A hosted service such as [auth0](https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-sets#:~:text=The%20JSON%20Web%20Key%20Set,signing%20JWTs%3A%20RS256%20and%20HS256.) may help to host the key for a public API endpoint.

```
{
    "keys": [
        {
            "kty": "EC",
            "use": "sig",
            "kid": "your-keyid-v1",
            "crv": "P-256",
            "alg": "ES256",
            "x": "lZU3Ic1QHBE5Ch9YajxQlqPicJL8lemiWfJga13RZrI",
            "y": "ddqibUSW8DiYexc4IUokdPYEcq5UO9grbaj13PkHGhM"
        }
    ]
}
```

<!-- TODO: Add image -->

## API Payload Hash

If the API method is POST, PUT or PATCH, the API payload will have to be hashed with SHA-256. The Payload should be standardized [as below](#apex-standardized-json-payload) (for JSON payload).

<!-- TODO: Include Sample Code -->

## <small>**APEX Standardized JSON Payload**

For purposes of consistency of SHA256 data hash across different OS to ease troubleshooting, API payload containing JSON object and data shall be serialized into a single string, and hashed, before sending the serialized string as the payload for the API request.

The serialized string shall not have any white spaces, tabs, carriage returns ('\r' or 0x0D) or linefeed ('\n' or 0x0A) before or after any of the structural characters of JSON (ie. left square bracket '[', left curly bracket '{', right square bracket ']', right curly bracket '}', colon ':', comma ',').

One might describe this JSON string as "without formatting" or compressed.
This is as different operating systems and applications may parse different formatting characters differently (eg. Windows Servers might treat a new line as CRLF ('\r\n' or 0x0D 0x0A) while UNIX-based systems might treat a new line as LF ('\n' or 0x0A) ).</small>

```
An example of an APEX standardized JSON string is:

{"Image":{"Width":800,"Height":600,"Title":"View from 15th Floor","Thumbnail":{"Url":"http://www.example.com/image/481989943","Height": 125,"Width":100},"Animated":false,"IDs":[116,943,234,38793]}}
```

## Generating JWT

The JWT can be generated using common libraries available based on RFC7519 with the following claims:

|S/No|JWT Claim|Comments|
|---|---|---|
|1  |alg|Only '***RS256***' and '***ES256***' are accepted.|
|2  |typ|Only '***JWT***' is accepted.|
|3  |kid|This is the key ID of the public key used to validate signature. APEX recommends monthly key rotation of the signing key. (eg. ***your-keyid-v1***)|
|4  |iat|This is the epoch time in seconds issued at the of API call. This is usually generated by the signing library.|
|5  |exp|This is the epoch time in seconds of the expiry time of this JWT. The time cannot be more than 180 seconds of ***iat***.|
|6  |jti|This is a random text string (nonce) of at least 40 characters. A random UUID generator is recommended to be used to generate this.|
|7  |iss|This is your [API Key(s)](#prerequisites-api-keys) obtained above (eg. xxxxx-xx-xxxxx and should be delimited by comma '***,***' if there are more than 1 key. (eg. xxxxx-xx-xxxxx,yyyyy-yy-yyyyy)|
|8  |aud|This should match the [API endpoint URL](#prerequisites-api-endpoint-url), eg. ***https://public.api.gov.sg/agency/api***|
|9  |sub|This is the method of the API (eg. ***POST***)|
|10 |data|This is the SHA-256 [API Payload Hash](#api-payload-hash) of the payload generated above.|

<!-- TODO: Include Sample Code -->

## Authorization Header

The developer will have to attach the JWT to the **x-apex-jwt** header.  The JWT can be tested with the Hello World! APIs beforehand.

<!-- TODO: Include Example -->

## JWK Rotation

It is recommended that the JWK generated in the [Prerequisite](#prerequisites-jwks-endpoint) step used in the signing of JWT is rotated at least monthly.  As the JWKS consists of a collection (array) of JWKs, rotation can be done by replacing the JWKS entirely or by changing the Key ID (kid) if there are a number of JWKs in the JWKS published to APEX.

## Hello World! APIs

These [APIs](docs/hello-world/jwt-auth.md) can be subscribed to and can help the Devloper to test the signed JWT:

- Evaluate if the JWT authencation header has been generated correctly.
- Test and evaluate the SHA256 hash which is sent to the API.
